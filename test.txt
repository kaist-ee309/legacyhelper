# Testing Instructions for LegacyHelper Test Suites

This document explains how to run and use the pytest test suites for the LegacyHelper project.

## Available Test Files

1. **test_legacyhelper_comprehensive.py** - Comprehensive test suite for the entire legacyhelper module
2. **test_history_reader.py** - Focused tests for the history_reader module
3. **test/** - Directory containing existing unit tests for specific modules

## Prerequisites

1. Make sure you have pytest installed:
   ```bash
   uv sync
   # or
   pip install pytest
   ```

2. Ensure you're in the project root directory (where the test files are located).

## Running the Comprehensive Test Suite

### Run All Comprehensive Tests
```bash
pytest test_legacyhelper_comprehensive.py
```

### Run with Verbose Output
```bash
pytest test_legacyhelper_comprehensive.py -v
```

### Run with Extra Verbose Output
```bash
pytest test_legacyhelper_comprehensive.py -vv
```

### Run All Tests (Comprehensive + Existing)
```bash
# Run all test files
pytest test/ test_legacyhelper_comprehensive.py test_history_reader.py -v
```

### Run Specific Test Classes
```bash
# Test Agent functionality
pytest test_legacyhelper_comprehensive.py::TestAgent -v

# Test Model implementations
pytest test_legacyhelper_comprehensive.py::TestGeminiModel -v
pytest test_legacyhelper_comprehensive.py::TestOpenAIModel -v
pytest test_legacyhelper_comprehensive.py::TestClaudeModel -v

# Test Core modules
pytest test_legacyhelper_comprehensive.py::TestCommandParserComprehensive -v
pytest test_legacyhelper_comprehensive.py::TestCommandExecutorComprehensive -v

# Test Integration
pytest test_legacyhelper_comprehensive.py::TestIntegration -v
```

### Run with Coverage Report
```bash
# Install coverage if not already installed
pip install pytest-cov

# Run comprehensive tests with coverage
pytest test_legacyhelper_comprehensive.py --cov=legacyhelper --cov-report=html

# Run all tests with coverage
pytest test/ test_legacyhelper_comprehensive.py test_history_reader.py \
    --cov=legacyhelper --cov-report=html
```

## Comprehensive Test Suite Structure

The `test_legacyhelper_comprehensive.py` file contains tests for:

### Core Module Tests
1. **TestAgent**: Tests for Agent class
   - Initialization with/without model
   - get_response with history context
   - Conversation history management
   - Legacy CLI run method

2. **TestHistoryReader**: Tests for history_reader module
   - Shell history path detection
   - Sensitive data filtering
   - History reading and formatting

3. **TestCommandParserComprehensive**: Tests for CommandParser
   - Command extraction from markdown
   - Dangerous command detection
   - Best command selection

4. **TestCommandExecutorComprehensive**: Tests for CommandExecutor
   - Command execution
   - Error handling
   - Command validation

5. **TestInteractiveExecutorComprehensive**: Tests for InteractiveExecutor
   - Confirmation requirements
   - Safe command execution

### Model Module Tests
1. **TestBaseModel**: Tests for abstract BaseModel
   - Abstract class verification
   - Method definitions

2. **TestGeminiModel**: Tests for GeminiModel
   - Initialization with API keys
   - Response generation
   - Error handling

3. **TestOpenAIModel**: Tests for OpenAIModel
   - Initialization with API keys
   - Response generation
   - Error handling

4. **TestClaudeModel**: Tests for ClaudeModel
   - Initialization with API keys
   - Response generation
   - Error handling

5. **TestModelFactoryComprehensive**: Tests for ModelFactory
   - Provider listing
   - Model creation
   - Default model selection

### Integration Tests
1. **TestIntegration**: Tests for module interactions
   - Agent with history and model
   - Command parser with executor

## Running History Reader Tests

For focused testing of the history_reader module, see the detailed instructions below.

### Run with Verbose Output
```bash
pytest test_history_reader.py -v
```

### Run with Extra Verbose Output (shows print statements)
```bash
pytest test_history_reader.py -vv
```

### Run a Specific Test Class
```bash
# Test filtering functionality
pytest test_history_reader.py::TestFilterSensitiveData -v

# Test history reading functionality
pytest test_history_reader.py::TestReadRecentHistory -v

# Test path detection functionality
pytest test_history_reader.py::TestGetShellHistoryPath -v

# Test formatting functionality
pytest test_history_reader.py::TestFormatHistoryContext -v
```

### Run a Specific Test Method
```bash
# Test filtering API keys
pytest test_history_reader.py::TestFilterSensitiveData::test_filter_api_key_env_var -v

# Test reading zsh history
pytest test_history_reader.py::TestReadRecentHistory::test_read_history_with_zsh_format -v
```

### Run with Coverage Report
```bash
# Install coverage if not already installed
pip install pytest-cov

# Run tests with coverage
pytest test_history_reader.py --cov=legacyhelper.core.history_reader --cov-report=html
```

## Test Structure

The test file contains the following test classes:

1. **TestGetShellHistoryPath**: Tests for detecting shell history file paths
   - Tests zsh history detection
   - Tests bash history detection
   - Tests fallback mechanisms
   - Tests when no history file exists

2. **TestFilterSensitiveData**: Tests for filtering sensitive information
   - Tests filtering API keys from environment variables
   - Tests filtering passwords
   - Tests filtering command-line arguments
   - Tests filtering URLs with credentials
   - Tests filtering HTTP headers
   - Tests that normal commands are preserved

3. **TestReadRecentHistory**: Tests for reading shell history
   - Tests reading zsh format history (with timestamps)
   - Tests reading bash format history (plain commands)
   - Tests filtering sensitive data during read
   - Tests error handling
   - Tests ordering (most recent first)
   - Tests count limiting

4. **TestFormatHistoryContext**: Tests for formatting history context
   - Tests formatting empty history
   - Tests formatting single entry
   - Tests formatting multiple entries
   - Tests formatting with filtered entries

## Understanding the Mocks

The tests use `unittest.mock` to avoid reading actual shell history files:

- **@patch**: Decorator to replace functions/objects with mocks
- **mock_open**: Creates a mock file object for testing file operations
- **MagicMock**: Creates mock objects that can be configured to return specific values

### Example Mock Usage

```python
@patch('legacyhelper.core.history_reader.Path.home')
@patch.dict('os.environ', {'SHELL': '/bin/zsh'})
def test_get_zsh_history_path(self, mock_home):
    # This test mocks Path.home() and os.environ to simulate
    # a zsh environment without actually checking the real system
```

## Expected Test Results

When all tests pass, you should see output like:

```
test_history_reader.py::TestGetShellHistoryPath::test_get_zsh_history_path PASSED
test_history_reader.py::TestGetShellHistoryPath::test_get_bash_history_path PASSED
...
test_history_reader.py::TestFormatHistoryContext::test_format_with_filtered_entries PASSED

========== 20+ passed in X.XXs ==========
```

## Troubleshooting

### Import Errors
If you get import errors, make sure you're running from the project root:
```bash
cd /path/to/legacyhelper
pytest test_history_reader.py
```

### Module Not Found
If pytest can't find the `legacyhelper` module:
```bash
# Make sure you're in the virtual environment
source .venv/bin/activate  # or uv venv && source .venv/bin/activate

# Or install in development mode
uv sync
```

### Mock Issues
If mocks aren't working as expected, check:
1. The patch path matches the actual import path
2. The mock is configured correctly (return_value, side_effect, etc.)
3. The test is using the mocked version, not the real function

## Adding New Tests

To add new test cases:

1. Add a new test method to the appropriate test class
2. Use descriptive names starting with `test_`
3. Use mocks to avoid side effects (file I/O, environment variables, etc.)
4. Use assertions to verify expected behavior

Example:
```python
def test_filter_new_pattern(self):
    """Test filtering a new sensitive data pattern."""
    entry = 'export NEW_SECRET=secret123'
    result = filter_sensitive_data(entry)
    assert 'NEW_SECRET=***REDACTED***' in result
    assert 'secret123' not in result
```

## Integration with Existing Test Suite

To run this test along with all other tests:
```bash
# Run all tests in the test/ directory and root test files
pytest test/ test_history_reader.py -v
```

## Continuous Integration

These tests are designed to run in CI/CD pipelines:
- No external dependencies (uses mocks)
- No file system access (mocked)
- Fast execution
- Deterministic results

Run in CI:
```bash
pytest test_history_reader.py --tb=short
```

